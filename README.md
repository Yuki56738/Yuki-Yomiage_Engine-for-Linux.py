# Yomiage_Engine
Windows(Unix)で動く、Discordの読み上げBotです。色んな人の影響＆協力の下でできました。どうかご自由に使ってください！

# 概要
このBotはオープンソースであり、他の人が危害を加えない限りBotユーザーがコードを勝手に変更を加えてもしても構いません。僕（Airun）のこだわりで、「どのPCでも動く」という形で作成してるので「.txt」（テキスト）「.py」（Python）ファイルしかありません。（Jsonもありましたが面倒なのでTxtファイルに、それのせいでエンコードエラーが出ることがあります。ですがそれの解決法も書いておくのでご安心を）

動作OSは「Windows」をベースにしていますが、Pathを変えることによって「RaspberryPi」等のLinux環境でも動きます。その為、RaspberryPiで自作サーバーとして動かすことも可能です。Appleは持っていないのでどうすれば動くのかは自分でもわかりませんが、Linuxでできるなら多分Appleでも可能だと思います…　（正直Apple等の環境・動作確認はIssuesにて報告お願いします…）Linuxではインストールが「楽」らしいですが、自分、Windows派なのでRaspberry持っていてもまだインストールの方法がわかっていません。できたら近日やり方を公開します。Windowsでのインストールは少々大変ですが頑張れば動きます。
**インストール、頑張ってください！**

# インストール方法

殆どの作業はNemy_ZZさんのガイドにたどってやっています。もし、画像付きのガイドが欲しかったらそれに従ってやっていただくようお願いします。
https://qiita.com/Nemy/items/d895114d3ba9a9d7cb62

## Step 1 (Botの作成)
まずはDiscordのBotを作る必要があります、もしこれを終えていたら飛ばしても構いません。

1: このサイトにアクセスします：
https://discordapp.com/developers/applications/

2: ログインして右上にある「New　Application」をクリックして、名前を入力した後、新しいアプリケーションを作成してください。

3: アプリケーションメニューで、パズルピースの絵が隣りにある「Bot」のコーラムを押してください。

4:「Add Bot」のボタンを押して新規のBotを作成してください。(「Yes Do It」を押して、作成してください)

5: 画面に色々とチェックボックスが出てくるので、「PRESENCE INTENT」と「SERVER MEMBERS INTENT」のチェックボックスをオンにしてください。(公開するなら「Public Bot」をオンにしても大丈夫です。)

6: その下に「Copy」と「Regenerate」のボタンがあります。「Copy」の方を押して、Botのトークンをコピーして保存してください。 

7: レンチの絵がある「Oauth」のコーラムに移動してください。

8: 下にBotがチェックできるのでそこを押してください。

9: 更に下にScopesが出てくるので色々とチェックする必要があります。とりあえず、チェックしないと行けないのが：「View Channels」「Send Messages」「Manage Messages」「Embed Links」「Read Message History」「Connect」「Speak」「Use Voice Activity」と「Priority Speakers」です。

10: 下に、招待リンクができるので試しに自分のサーバーに招待してあげてください。

これでBotの基礎のインストールは完了です。**第一関門突破！まだまだ行きますよ！**

## Step 2 (Open_JTalk、日本語読み上げのソフトの導入)
次にDiscordに打ったメッセージを日本語に読み上げる用にWAVファイルを作成するフリーソフトを導入します。それが「Open_JTalk」なのですが、これはLinuxをベースにしたソフトであり、本来はWindowsには全くの無縁です。
これをWindowsで動かせるようにコンパイルする必要があります。色々やり方がありますが、今回は「Microsoft Visual 2019」を使用したやり方で行きます。

(これも**Nemy_ZZ**さんなどの資料をベースにしてあります。ありがとうございます…)

https://qiita.com/mkgask/items/0bf9c26dc96e7b0b45ac

http://truthfullscore.hatenablog.com/entry/2015/05/31/102221

1: https://visualstudio.microsoft.com/ja/　
に移動して、Microsoft Visual Studio 2019をインストールしてください。(Community（無料）で大丈夫です)。

2:　インストール時（最中）（もしくはインストールした後のVisual Studio Installer｛スタートで検索すれば出てきます｝）で「Visual C++」を選択してインストールする必要があります。ここと付いてくるソフトを使ってOpen_Jtalkをコンパイルします。

3: 「tar.gz」を解凍できるソフトを用意してください、CubeICEがおすすめです（7z、RARでもできますが解凍を２回行う必要があり、面倒です。）

4: "https://sourceforge.net/projects/hts-engine/"  にて、 「/hts_engine API/hts_engine_API-1.10/hts_engine_API-1.10.tar.gz」とか書いてあるソフトをダウンロードします（とりあえず、開いてる所へ、Desktopで構いませんがNemy_ZZさん曰く`「解凍先ディレクトリのパスが2バイト文字を含んでいると面倒なことが起こる時があるので、
2バイト文字を含まないディレクトリに移動しておくと楽です」`と記しているのでご注意を。）

5: "https://sourceforge.net/projects/open-jtalk/"  で、「　/Open JTalk/open_jtalk-1.11/open_jtalk-1.11.tar.gz　」（多分一番上）をダウンロードします。

6: 同じサイトで下にある、「　/Dictionary/open_jtalk_dic-1.11/open_jtalk_dic_shift_jis-1.11.tar.gz　」（多分上から４番目）をダウンロードします。これが日本語の脳になります。（UTF-8バージョンがありますが、Windowsだと動かないので泣く泣くパス…）｡ﾟ(ﾟ´Д｀ﾟ)ﾟ｡

7: "https://sourceforge.net/projects/open-jtalk/files/HTS%20voice/" で、「　hts_voice_nitech_jp_atr503_m001-1.05　」を選択して、「　hts_voice_nitech_jp_atr503_m001-1.05.tar.gz　」をダウンロードします、

8: **ここからが大変！** まず、PCが32bitか64bitに対応してるのか確認します。（これは割愛します）

9: 次に「Windows explorer」で「C:\Program Files (x86)\Microsoft Visual Studio」に移動、中から「vcvarsall.bat」というソフトを探します。ファイル内で「Windows Search」を使うと良いかもしれません。（もしかしたら「C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build」にあるかも…、バージョンが違うとPathも違うので）見つけたら、そこのPathをCopyなどでメモってください。

10: 「Windows explorer」で「hts_engine_API-1.10.tar.gz」が保存してある所に移動して解凍してください。次に上のURL（？）ダイレクトリー(Directory、C:/なんちゃらほんちゃらと書いてある所)で「cmd」と上書きしてください。するとコマンドプロンプトが出てくるので以下のコードを打ってください:
```
call (さっきのvcarsall.batのディイレクトリーにvcarsall.batを付け加えて、スペースを打った後に32か64と打ってください（PCが対応してる次第で）)
nmake -f Makefile.mak
nmake -f Makefile.mak install
```
（ここでエラーが出た場合、面倒なやり方をやらないといけません：コマンドプロンプトを「管理者として実行」、そこのPathまで「cd」を駆使して移動、上のコードで再チャレンジする必要があります。）

すると、あら不思議「C:\」で「hts_engine_API」が出来上がってるじゃないですか！こいつはここにおいておくので無視。（もういらないので元々の「なんちゃらほんちゃら.tar.gz」などのファイルを消しておくと多分良いかも…）

11: 今度は「open_jtalk-1.10.tar.gz」を解凍して、10（前回）と同じ操作をします。最後の `nmake -f Makefile.mak install`でエラーが出ますが、問題は無いので無視して大丈夫です。何が起こってるのかとおいうと、Dictionary、つまり辞書、の生成に問題があるだけで、後から埋め込むので問題はないです。とりあえず「C:\open_jtalk\bin\open_jtalk.exe」ができていたら問題はないです。

12:「open_jtalk_dic_shift_jis-1.10.tar.gz」を解凍して、そのファイルを「dic」と名前を変更します。それを「C:\open_jtalk\bin\」に移してください（上書きして大丈夫です。）

13: 「hts_voice_nitech_jp_atr503_m001-1.05.tar.gz」を解凍して、"ファイルごと"「C:\open_jtalk\bin\」に移してください。（ファイルごとなのは、プログラムで、Pathがそうなってるからです）。

これで、Open JTalkのインストールは完了デス！
ライセンスも確認して進めてください（2021年）。

対象：ライセンス
hts_engine_API：Modified BSD license
Open JTalk：Modified BSD license
ボイス：Creative Commons Attribution 3.0

**第二関門突破！　残り３つ頑張ってください！**

## Step 3 (FFMPEGの導入)
正直、これが一番分かりづらかったことです。慎重に行きましょう。これはOpen＿Jtalkが作成したWAVファイルをDiscordで音声を流すためのソフトです。後、FFMPEG自体、コロコロとサイトの内容とか変えるので時間が立つにつれて難しくなることがあります、ご注意を。

参考：https://web.plus-idea.net/2015/11/windows-ffmpeg/

1: "https://www.ffmpeg.org/" に飛びましょう、そして「Download」を押します。

2: 次にWindowsのロゴが描かれてる青いボタンをの上にカーソルを合わせましょう。そうすると下（Windows EXE Files) に２種類のダウンロードサイトが出てきます。「gyan.dev」と「BtbN」、両方とも同じものを配布しているのですが、色々と調べると面倒です（ここは正直、ユーザーの判断で行きたい）。今回は「gyan.dev」で行きます (64 bitなら「BtbN」もあり）。

3: ffmpegサイトで少し下に行くと「Git」の部門があって、そこに "https://www.gyan.dev/ffmpeg/builds/ffmpeg-git-full.7z" というリンクがあります。そこからファイルをダウンロードしましょう。結構、ダウンロードが長いので辛抱…

4: ダウンロード終えたら、「7zip」などの解凍ソフトで解凍しましょう、そして出てきたファイルの名前を「ffmpeg」に変えておきましょう。後で便利になります。

5: そのファイルをまた「C:\open_jtalk\bin\」に移動してください。

6: 「コントロールパネル」を開きます。スタートメニューで検索したほうが良いかもしれません。

7: コントロールパネルで「システムの詳細設定の表示」をクリックします。

8: 出てきたウインドウの右下に「環境変数」のボタンがあるのでクリック。

9:　するとユーザーとシステムの環境変数の設定が出てきます。まずは「ユーザー環境変数」（上のリスト）で「新規」のボタンを押します。すると変数名と変数値を設定を要求されます。変数名は「ffmpeg」にセットしてください。

10:　で、肝心の変数値なんですが、左下の「ディレクトリの参照」で「C:\open_jtalk\bin\ffmpeg\」に健在する「ffmpeg.exe」を探します。時代によってDirectoryは変わるので自力で探してほしいのですが、多分：「C:\open_jtalk\bin\ffmpeg\bin\」にあります。そしたら、「ffmpeg.exe」を選択してください。変数値が「ffmpeg」まで行くディレクトリになるはずです。最後に「OK」を押して終了です。

11: システムの環境変数にも同じように変数名、変数値を作ってください。

**第三関門突破です！　半分（５分の３）突破です！ネバーギブアップ！**

## Step 4 (ボイスの導入)
ここからは、ボイスの導入に入ります。くじけず、頑張ってください！これはどちらかと言うとめんどくさい。

参考場所は "https://petile.com/mahoroba/e1875.html" です、Yhay81さんが薦めていました。かなりいいです、これをベースに行きます。

1: とりあえず、まずはダウンロードの繰り返しです。まずはMMDAgent "https://ja.osdn.net/projects/sfnet_mmdagent/releases/" が公開してる「MMDAgent_Example-1.8.zip」をダウンロードします。（ダウンロードが始まらないなら、外部リンクをクリックする必要があります。）

2: 次に「東北大学 大学院工学研究科 通信工学専攻 伊藤・能勢研究室」が公開してるボイス "https://github.com/icn-lab/htsvoice-tohoku-f01" をダウンロードします。右にある、緑色の「Code」のボタンから、クリックし、「Download Zip」を押して「htsvoice-tohoku-f01-master.zip」をダウンロードしてください。

3: "http://akihiro0105.web.fc2.com/Downloads/Downloads-htsvoice.html" に載ってるボイス（多分３１こ）全部ダウンロードしてください。全部Zipで保存されております。

4: 「C:\open_jtalk\bin\」にて、新しいファイル「hts_voice」を作ってください。

5: 「MMDAgent_Example-1.8.zip」を解凍して、中の「Voice」ファイル、「mei」ファイルを先程作った「hts_voice」に移動してください。（中の「COYRIGHT.txt」と「README.txt」のご確認をお願いします、タダで使わせて頂いてるのでその辺りは確認をお願いします）。

6: 次に「htsvoice-tohoku-f01-master.zip」を解凍してください。そして、そのファイルごとを先程の「hts_voice」内に移してください。

7: 最後に、残りのZipファイル("http://akihiro0105.web.fc2.com/Downloads/Downloads-htsvoice.html"　からダウンロードしたZipファイル)を一斉解凍してください、広い所、作業がやりやすい所でやると良いです！

8: そして、中のファイルから一つ、一つ、「hts_voice」にうつしてください。だけど、それだとあまりにも苦痛なので、一括で動かせる方法を教えます。

8.1: まず、そのファイルを「hts_voice」とは別のファイルに移す。（自分はデスクトップで、「Dummy」としてやりました。）

8.2: 次に、Windowsのファイル検索機能を使って 「.htsvoice」を検索します。すると場所関係なく、そのファイルの中にある全部の「.htsvoice」ファイルを全部探してくれます。

8.3:　それを「Ctrl + A」コマンドで全選択、そして「Ctrl + C」でコピーしてください。

8.4: 「hts_voice」の中に行った後、そこで「Ctrl + V」でペーストしてください。そうすれば手間を大幅に短縮でき、ファイル（３１個）全部一瞬に移せます。

**第四関門突破です！これでボイスの設定は終了です。次がラスト！最後は楽しいからがんばれ！**

## Step 5 (ボットのセットアップと起動)

1: ここにあるファイルを全部ダウンロードします。右の緑色の「Code」ボタンから「Download Zip」とやったほうが良いかもしれません。

2: そのファイルを解凍し、中身（ファイルではなく中身！）を全部、「C:\open_jtalk\bin\」移します。

3: "https://www.python.org/" で、最新バージョンのパイソンをダウンロードします(Downloadの下に「Latest」がありますので、その隣のリンクからダウンロード。)

4: 普通にインストール、これは割愛します。

5: コマンドプロンプトを開きます。一番やりやすいのが、Start(スタート)メニューで「cmd」と入力することです。できるなら、「管理者として実行」で起動してください。

6: コマンドプロンプトでまず： `python3 -m pip install --upgrade pip`　でインストールする準備をして、次に `python3 -m pip install -U discord.py`　などでPythonでDiscordを動かす準備をシてください。（これで、もういらないので消して構いません）

7: また「C:\open_jtalk\bin\」に移動して、「output.zip」を解凍してください。解凍したファイルは「hts_voice」内に移動させてください。

8: read_bot.pyをテキストエディターなどで開いて、「Default_Prefix」「Bot_key」「Bot_Author」を設定します。

8.1: 「Default_Prefix」でボットを動かすためのコマンドを設定します、例として　"!yomi "　とかで設定してください。（スペースを最後に入れるとコマンドと命令の間のスペースを入れることができます）。

8.2: 「Bot_key」は(Step 1)で取得したボットのTokenを　"数字の並び"　として入れてください。例として："1234567890.12345.1234567890"

8.3: 「Bot_Author」ではあなたの名前を入れてください！

9: input1.txtとinput2.txtを一度開いて、そのままウインドウの左上にあるファイルから「名前を付けて保存」をおしてください。ウインドウが開くので、右下にあるエンコードを「UTF-8」ではなく「ANSI」として保存してください。これ、Shift_Jis対応なのでエンコードバグを直すためにです。

10: 次からのステップは個人の自由ですが、起動が楽になるのでおすすめです、「C:\Users\（ユーザー）\AppData\Local\Programs\Python\Python39」にある「Python.exe」でまず右クリックからのコマンドでショートカットを作ってください。(もしくはStart(スタート)メニューでPythonを検索してファイルの場所まで飛んで、以下同文の動作をしてください)

11: 次に、そのショートカットを「C:\open_jtalk\bin\」に移してください。

12: そのショートカットの名前を自由に変えてください、「read_bot_Python.exe」に変更するのが楽です。

13: 右クリックでショートカットのプロパティを開いてください。

14: リンク先を「C:\Users\pokem\AppData\Local\Programs\Python\Python39\python.exe read_bot.py」、作業フォルダーを「C:\open_jtalk\bin」として設定して「OK」をおしてください。

10: 最後に「read_bot_Python.exe」をクリックして起動してください。

11: Discordに移ります

12: ボイチャに入ります。

13: 入った後、メッセージサーバーで　<決めたコマンド>hello　(例：!yomi hello)と入力してボットを呼んでください。

14: 初期ではボット自身が読み上げます。読み上げたら成功です！試しに好きにメッセージを送ってください、その文章を読み上げます！

15: 詳しい説明は　<決めたコマンド>help　として見ることができます！

**おめでとうございます！全関門制覇です！どうか読み上げ人生を楽しんでください！**

コマンド一覧です：（かっこで囲まれてる文字は別の書き方です。これもコマンドを前においてください。）

<コマンド>help                                     -ヘルプ文を表示します

<コマンド>settings (setting)　                     -設定を表示します

<コマンド>troubleshoot (ts)                        -トラブルシューティングの手順を出します

<コマンド>voicelist (vl)                           -使えるボイスのリストを出します。

<コマンド>hello (join)(start)(s)(connect)          -ボイスチャットにbotを参加させます。

<コマンド>bye (leave)(disconnect)(dc)(end)(e)      -botをボイスチャットから切断します。

<コマンド>reboot (rb)                              -再起動します。

<コマンド>move (m)                                 -別のボイスチャットに移動します。（今、コマンドを送った人がいるボイスチャットにです）

<コマンド>addword (aw)                             -サーバー辞書に別の読み上げ方をしてほしい文字を足します。（設定が特殊なのでお気をつけて）

<コマンド>deleteword (dw)                          -サーバー辞書から単語を消します。（設定が特殊なのでお気をつけて）

<コマンド>addserver (as)                           -読み上げたいメッセージサーバー（テキストチャンネル）を足します。

<コマンド>deleteserver (ds)                        -読み上げたくないメッセージサーバー（テキストチャンネル）を足します。

設定コマンド一覧です、書き方は「<コマンド>setting」もしくは「<コマンド>settings」でオッケーです。

<コマンド>setting       -各設定の詳細が見れます。

<コマンド>setting voice -声の設定ができます（設定が特殊なのでお気をつけて）

<コマンド>setting name  -メッセージを書いた人の名前を読み上げます。

<コマンド>setting botread -このBotのメッセージを読み上げます。

<コマンド>setting mention -メンションを読み上げます。

<コマンド>setting readotherbot -このBot以外の文章を読み上げます。（正直、おすすめしません）

<コマンド>setting length -読み上げる長さ（文字数）を設定できます。（設定が特殊なのでお気をつけて）

<コマンド>setting emoji -絵文字の読み上げを設定できます。

<コマンド>setting deleteallword -サーバー辞書に設定された文字を全部消します。（戻せないのでお気をつけて！）

<コマンド>setting prefix -サーバー固有のコマンドが設定できます。（全体的には変わらないのでご安心を）

<コマンド>setting addblacklist - (権限者用のコマンドです。) ユーザーをブラックリスト（コマンド制限）に足すことができます。（設定が特殊なのでお気をつけて）

<コマンド>setting removeblacklist - (権限者用のコマンドです。) ユーザーをブラックリスト（コマンド制限）から解除する事ができます。（設定が特殊なのでお気をつけて）
    
# あとがき
ここではDiscordで最近流行りの読み上げBotのコードを提供しております。ボイスチャットで聞き専（理由により声が出せない人）用のBotであり、メッセージチャットで書かれた文章を変換してDiscordで読み上げる、そういうBotです。自分はゲーマーなのでそういうのは結構必須になってきます。今ある有名なBotは「Shovel, 喋太郎」とかがありますが、色々と機能不足だったり、サーバーが満杯で使えないなどの問題が多発していました。

その時期を境に、僕がふと思ったのが、Botは簡単に作れるので、自分で動かせないかと思いました。そこでオンラインでBotのソースコードを探し回りましたが、どれも良いんですが、色々とイマイチで使い勝手とかが難しかったりとか、機能不足とか、OSが違うとかが結構多くありました。それをきっかけに自分でコードを書いてみようと思いました。自分、Pythonには触ったことがなかったので（C++が本命です）色んな人から僕にコードの書き方、アドバイス、デバックに付き合ってくれました。凄い方からは長文のリストをわざわざ書いてくれることもありました。書き始めてから１ヶ月間、この事で頭が一杯で短大でも集中が入らないときが時々ありました。（笑）で、最後の方には自分でも気づかなかったぐらいPythonに手慣れていて、オンラインのプログラミングフォーラム（Stack Overflow等）のコードでも分かるようになっていました。で、そこからのいくつかのコードを参考にして作りました。（正直、ここからの情報が凄いので、オンラインの皆さん、ありがとうございます。）

で、完成したのがこのBotです。（自分、大のイルカ好きで自分個人のBotでは「読ませてみるか」を文字って「読ませているか」と名付けています。ｗ）
いろんな機能を他のBotと真似たりとかして、このBotは、今ある「Shovel」と同等の機能を出すことができます。
正直、Shovelがよく、サーバー満杯になることが多かったのでそれを対抗（？）する形でこのBotを作りました。でも、自分自身だけではここまでのコードを書くことができませんでした。改めて：**Nemy_zz, Yhay81, TogeRaz, Tom_XV, Baku_reshi, Yuki_Trans**さんの皆さんに感謝を申し上げます。
